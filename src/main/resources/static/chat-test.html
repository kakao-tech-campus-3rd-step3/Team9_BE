<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pado 채팅 테스트</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .container {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .chat-messages {
            height: 400px;
            border: 1px solid #ccc;
            padding: 10px;
            overflow-y: scroll;
            margin-bottom: 10px;
            background-color: #f9f9f9;
        }
        .message {
            margin-bottom: 10px;
            padding: 8px;
            border-radius: 4px;
            background-color: white;
        }
        .message-header {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }
        .message-content {
            font-size: 14px;
        }
        .input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }
        .input-group input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .btn-primary {
            background-color: #007bff;
            color: white;
        }
        .btn-success {
            background-color: #28a745;
            color: white;
        }
        .btn-danger {
            background-color: #dc3545;
            color: white;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 10px;
        }
        .status.connected {
            background-color: #d4edda;
            color: #155724;
        }
        .status.disconnected {
            background-color: #f8d7da;
            color: #721c24;
        }
        .logs {
            height: 150px;
            border: 1px solid #ccc;
            padding: 10px;
            overflow-y: scroll;
            background-color: #f8f8f8;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <h1>🌊 Pado 채팅 시스템 테스트</h1>
    
    <div class="container">
        <h2>연결 설정</h2>
        <div class="input-group">
            <input type="number" id="studyId" placeholder="스터디 ID (예: 1)" value="1">
            <input type="text" id="authToken" placeholder="JWT 토큰 (Bearer 제외)">
        </div>
        <div class="input-group">
            <button class="btn btn-success" onclick="connect()">연결</button>
            <button class="btn btn-danger" onclick="disconnect()">연결 해제</button>
            <button class="btn btn-primary" onclick="loadChatHistory()">채팅 기록 불러오기</button>
        </div>
        <div id="connectionStatus" class="status disconnected">연결되지 않음</div>
    </div>

    <div class="container">
        <h2>채팅</h2>
        <div id="chatMessages" class="chat-messages"></div>
        <div class="input-group">
            <input type="text" id="messageInput" placeholder="메시지를 입력하세요..." maxlength="1000">
            <button class="btn btn-primary" onclick="sendMessage()">전송</button>
        </div>
    </div>

    <div class="container">
        <h2>로그</h2>
        <div id="logs" class="logs"></div>
        <button class="btn btn-primary" onclick="clearLogs()">로그 지우기</button>
    </div>

    <div class="container">
        <h2>사용법</h2>
        <ol>
            <li><strong>JWT 토큰 발급:</strong> 로그인 API로 토큰을 받아서 위에 입력</li>
            <li><strong>스터디 ID:</strong> 테스트할 스터디의 ID 입력</li>
            <li><strong>연결:</strong> "연결" 버튼 클릭</li>
            <li><strong>메시지 전송:</strong> 메시지 입력 후 "전송" 버튼 클릭</li>
            <li><strong>DB 확인:</strong> "채팅 기록 불러오기"로 저장된 메시지 확인</li>
        </ol>
        <p><strong>API 엔드포인트:</strong></p>
        <ul>
            <li>WebSocket: <code>ws://localhost:8080/ws</code></li>
            <li>채팅 기록: <code>GET /api/studies/{studyId}/chats</code></li>
        </ul>
    </div>

    <script>
        let stompClient = null;
        let currentStudyId = null;

        function log(message) {
            const logs = document.getElementById('logs');
            const timestamp = new Date().toLocaleTimeString();
            logs.innerHTML += `[${timestamp}] ${message}\n`;
            logs.scrollTop = logs.scrollHeight;
        }

        function clearLogs() {
            document.getElementById('logs').innerHTML = '';
        }

        function updateConnectionStatus(connected) {
            const status = document.getElementById('connectionStatus');
            if (connected) {
                status.className = 'status connected';
                status.textContent = `스터디 ${currentStudyId} 채팅방에 연결됨`;
            } else {
                status.className = 'status disconnected';
                status.textContent = '연결되지 않음';
            }
        }

        function connect() {
            const studyId = document.getElementById('studyId').value;
            const authToken = document.getElementById('authToken').value;

            if (!studyId) {
                alert('스터디 ID를 입력해주세요');
                return;
            }

            if (!authToken) {
                alert('JWT 토큰을 입력해주세요');
                return;
            }

            currentStudyId = studyId;
            
            log('WebSocket 연결 시도...');
            
            // WebSocket + STOMP 연결 (SockJS 없이 순수 WebSocket 사용)
            const socket = new WebSocket(`ws://localhost:8080/ws`);
            stompClient = Stomp.over(socket);
            
            // 헤더에 인증 토큰 추가
            const headers = {
                'Authorization': `Bearer ${authToken}`
            };

            stompClient.connect(headers, function(frame) {
                log('WebSocket 연결 성공: ' + frame);
                updateConnectionStatus(true);
                
                // 스터디 채팅방 구독
                stompClient.subscribe(`/topic/studies/${studyId}/chats`, function(message) {
                    const chatMessage = JSON.parse(message.body);
                    displayMessage(chatMessage);
                    log('메시지 수신: ' + JSON.stringify(chatMessage));
                });

                // 에러 메시지 구독
                stompClient.subscribe('/user/queue/errors', function(message) {
                    const error = JSON.parse(message.body);
                    log('에러 수신: ' + JSON.stringify(error));
                    alert(`에러: ${error.message}`);
                });

                log(`스터디 ${studyId} 채팅방 구독 완료`);
                
            }, function(error) {
                log('WebSocket 연결 실패: ' + error);
                updateConnectionStatus(false);
                alert('연결 실패: ' + error);
            });
        }

        function disconnect() {
            if (stompClient !== null) {
                stompClient.disconnect();
                log('WebSocket 연결 해제');
            }
            updateConnectionStatus(false);
            currentStudyId = null;
        }

        function sendMessage() {
            const messageInput = document.getElementById('messageInput');
            const content = messageInput.value.trim();

            if (!content) {
                alert('메시지를 입력해주세요');
                return;
            }

            if (!stompClient || !stompClient.connected) {
                alert('먼저 채팅방에 연결해주세요');
                return;
            }

            const message = {
                content: content
            };

            log(`메시지 전송 시도: ${content}`);
            
            // 메시지 전송
            stompClient.send(`/app/studies/${currentStudyId}/chats`, {}, JSON.stringify(message));
            
            messageInput.value = '';
        }

        function displayMessage(message) {
            const chatMessages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message';
            
            const timestamp = new Date(message.createdAt).toLocaleString();
            
            messageDiv.innerHTML = `
                <div class="message-header">
                    <strong>${message.senderName}</strong> - ${timestamp}
                </div>
                <div class="message-content">${escapeHtml(message.content)}</div>
            `;
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        async function loadChatHistory() {
            const authToken = document.getElementById('authToken').value;
            const studyId = document.getElementById('studyId').value;

            if (!authToken || !studyId) {
                alert('스터디 ID와 JWT 토큰을 입력해주세요');
                return;
            }

            try {
                log('채팅 기록 불러오는 중...');
                
                const response = await fetch(`/api/studies/${studyId}/chats?size=50`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    log(`채팅 기록 ${data.messages.length}개 불러옴`);
                    
                    // 기존 메시지 지우기
                    document.getElementById('chatMessages').innerHTML = '';
                    
                    // 메시지 표시 (오래된 순서대로)
                    data.messages.reverse().forEach(message => {
                        displayMessage(message);
                    });
                    
                } else {
                    const errorText = await response.text();
                    log(`채팅 기록 불러오기 실패: ${response.status} ${errorText}`);
                    alert(`채팅 기록 불러오기 실패: ${response.status}`);
                }
            } catch (error) {
                log('채팅 기록 불러오기 에러: ' + error);
                alert('채팅 기록 불러오기 에러: ' + error.message);
            }
        }

        // Enter 키로 메시지 전송
        document.getElementById('messageInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        // 페이지 로드 시
        window.onload = function() {
            log('채팅 테스트 페이지 로드됨');
            log('사용 전에 JWT 토큰과 스터디 ID를 입력하세요');
        };

        // 페이지 종료 시 연결 해제
        window.addEventListener('beforeunload', function() {
            if (stompClient !== null) {
                stompClient.disconnect();
            }
        });
    </script>
</body>
</html>