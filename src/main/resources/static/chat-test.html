<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pado ì±„íŒ… í…ŒìŠ¤íŠ¸</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .container {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .chat-messages {
            height: 400px;
            border: 1px solid #ccc;
            padding: 10px;
            overflow-y: scroll;
            margin-bottom: 10px;
            background-color: #f9f9f9;
        }
        .message {
            margin-bottom: 10px;
            padding: 8px;
            border-radius: 4px;
            background-color: white;
        }
        .message-header {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }
        .message-content {
            font-size: 14px;
        }
        .input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }
        .input-group input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .btn-primary {
            background-color: #007bff;
            color: white;
        }
        .btn-success {
            background-color: #28a745;
            color: white;
        }
        .btn-danger {
            background-color: #dc3545;
            color: white;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 10px;
        }
        .status.connected {
            background-color: #d4edda;
            color: #155724;
        }
        .status.disconnected {
            background-color: #f8d7da;
            color: #721c24;
        }
        .logs {
            height: 150px;
            border: 1px solid #ccc;
            padding: 10px;
            overflow-y: scroll;
            background-color: #f8f8f8;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <h1>ğŸŒŠ Pado ì±„íŒ… ì‹œìŠ¤í…œ í…ŒìŠ¤íŠ¸</h1>
    
    <div class="container">
        <h2>ì—°ê²° ì„¤ì •</h2>
        <div class="input-group">
            <input type="number" id="studyId" placeholder="ìŠ¤í„°ë”” ID (ì˜ˆ: 1)" value="1">
            <input type="text" id="authToken" placeholder="JWT í† í° (Bearer ì œì™¸)">
        </div>
        <div class="input-group">
            <button class="btn btn-success" onclick="connect()">ì—°ê²°</button>
            <button class="btn btn-danger" onclick="disconnect()">ì—°ê²° í•´ì œ</button>
            <button class="btn btn-primary" onclick="loadChatHistory()">ì±„íŒ… ê¸°ë¡ ë¶ˆëŸ¬ì˜¤ê¸°</button>
        </div>
        <div id="connectionStatus" class="status disconnected">ì—°ê²°ë˜ì§€ ì•ŠìŒ</div>
    </div>

    <div class="container">
        <h2>ì±„íŒ…</h2>
        <div id="chatMessages" class="chat-messages"></div>
        <div class="input-group">
            <input type="text" id="messageInput" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." maxlength="1000">
            <button class="btn btn-primary" onclick="sendMessage()">ì „ì†¡</button>
        </div>
    </div>

    <div class="container">
        <h2>ë¡œê·¸</h2>
        <div id="logs" class="logs"></div>
        <button class="btn btn-primary" onclick="clearLogs()">ë¡œê·¸ ì§€ìš°ê¸°</button>
    </div>

    <div class="container">
        <h2>ì‚¬ìš©ë²•</h2>
        <ol>
            <li><strong>JWT í† í° ë°œê¸‰:</strong> ë¡œê·¸ì¸ APIë¡œ í† í°ì„ ë°›ì•„ì„œ ìœ„ì— ì…ë ¥</li>
            <li><strong>ìŠ¤í„°ë”” ID:</strong> í…ŒìŠ¤íŠ¸í•  ìŠ¤í„°ë””ì˜ ID ì…ë ¥</li>
            <li><strong>ì—°ê²°:</strong> "ì—°ê²°" ë²„íŠ¼ í´ë¦­</li>
            <li><strong>ë©”ì‹œì§€ ì „ì†¡:</strong> ë©”ì‹œì§€ ì…ë ¥ í›„ "ì „ì†¡" ë²„íŠ¼ í´ë¦­</li>
            <li><strong>DB í™•ì¸:</strong> "ì±„íŒ… ê¸°ë¡ ë¶ˆëŸ¬ì˜¤ê¸°"ë¡œ ì €ì¥ëœ ë©”ì‹œì§€ í™•ì¸</li>
        </ol>
        <p><strong>API ì—”ë“œí¬ì¸íŠ¸:</strong></p>
        <ul>
            <li>WebSocket: <code>ws://localhost:8080/ws</code></li>
            <li>ì±„íŒ… ê¸°ë¡: <code>GET /api/studies/{studyId}/chats</code></li>
        </ul>
    </div>

    <script>
        let stompClient = null;
        let currentStudyId = null;

        function log(message) {
            const logs = document.getElementById('logs');
            const timestamp = new Date().toLocaleTimeString();
            logs.innerHTML += `[${timestamp}] ${message}\n`;
            logs.scrollTop = logs.scrollHeight;
        }

        function clearLogs() {
            document.getElementById('logs').innerHTML = '';
        }

        function updateConnectionStatus(connected) {
            const status = document.getElementById('connectionStatus');
            if (connected) {
                status.className = 'status connected';
                status.textContent = `ìŠ¤í„°ë”” ${currentStudyId} ì±„íŒ…ë°©ì— ì—°ê²°ë¨`;
            } else {
                status.className = 'status disconnected';
                status.textContent = 'ì—°ê²°ë˜ì§€ ì•ŠìŒ';
            }
        }

        function connect() {
            const studyId = document.getElementById('studyId').value;
            const authToken = document.getElementById('authToken').value;

            if (!studyId) {
                alert('ìŠ¤í„°ë”” IDë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”');
                return;
            }

            if (!authToken) {
                alert('JWT í† í°ì„ ì…ë ¥í•´ì£¼ì„¸ìš”');
                return;
            }

            currentStudyId = studyId;
            
            log('WebSocket ì—°ê²° ì‹œë„...');
            
            // WebSocket + STOMP ì—°ê²° (SockJS ì—†ì´ ìˆœìˆ˜ WebSocket ì‚¬ìš©)
            const socket = new WebSocket(`ws://localhost:8080/ws`);
            stompClient = Stomp.over(socket);
            
            // í—¤ë”ì— ì¸ì¦ í† í° ì¶”ê°€
            const headers = {
                'Authorization': `Bearer ${authToken}`
            };

            stompClient.connect(headers, function(frame) {
                log('WebSocket ì—°ê²° ì„±ê³µ: ' + frame);
                updateConnectionStatus(true);
                
                // ìŠ¤í„°ë”” ì±„íŒ…ë°© êµ¬ë…
                stompClient.subscribe(`/topic/studies/${studyId}/chats`, function(message) {
                    const chatMessage = JSON.parse(message.body);
                    displayMessage(chatMessage);
                    log('ë©”ì‹œì§€ ìˆ˜ì‹ : ' + JSON.stringify(chatMessage));
                });

                // ì—ëŸ¬ ë©”ì‹œì§€ êµ¬ë…
                stompClient.subscribe('/user/queue/errors', function(message) {
                    const error = JSON.parse(message.body);
                    log('ì—ëŸ¬ ìˆ˜ì‹ : ' + JSON.stringify(error));
                    alert(`ì—ëŸ¬: ${error.message}`);
                });

                log(`ìŠ¤í„°ë”” ${studyId} ì±„íŒ…ë°© êµ¬ë… ì™„ë£Œ`);
                
            }, function(error) {
                log('WebSocket ì—°ê²° ì‹¤íŒ¨: ' + error);
                updateConnectionStatus(false);
                alert('ì—°ê²° ì‹¤íŒ¨: ' + error);
            });
        }

        function disconnect() {
            if (stompClient !== null) {
                stompClient.disconnect();
                log('WebSocket ì—°ê²° í•´ì œ');
            }
            updateConnectionStatus(false);
            currentStudyId = null;
        }

        function sendMessage() {
            const messageInput = document.getElementById('messageInput');
            const content = messageInput.value.trim();

            if (!content) {
                alert('ë©”ì‹œì§€ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”');
                return;
            }

            if (!stompClient || !stompClient.connected) {
                alert('ë¨¼ì € ì±„íŒ…ë°©ì— ì—°ê²°í•´ì£¼ì„¸ìš”');
                return;
            }

            const message = {
                content: content
            };

            log(`ë©”ì‹œì§€ ì „ì†¡ ì‹œë„: ${content}`);
            
            // ë©”ì‹œì§€ ì „ì†¡
            stompClient.send(`/app/studies/${currentStudyId}/chats`, {}, JSON.stringify(message));
            
            messageInput.value = '';
        }

        function displayMessage(message) {
            const chatMessages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message';
            
            const timestamp = new Date(message.createdAt).toLocaleString();
            
            messageDiv.innerHTML = `
                <div class="message-header">
                    <strong>${message.senderName}</strong> - ${timestamp}
                </div>
                <div class="message-content">${escapeHtml(message.content)}</div>
            `;
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        async function loadChatHistory() {
            const authToken = document.getElementById('authToken').value;
            const studyId = document.getElementById('studyId').value;

            if (!authToken || !studyId) {
                alert('ìŠ¤í„°ë”” IDì™€ JWT í† í°ì„ ì…ë ¥í•´ì£¼ì„¸ìš”');
                return;
            }

            try {
                log('ì±„íŒ… ê¸°ë¡ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...');
                
                const response = await fetch(`/api/studies/${studyId}/chats?size=50`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    log(`ì±„íŒ… ê¸°ë¡ ${data.messages.length}ê°œ ë¶ˆëŸ¬ì˜´`);
                    
                    // ê¸°ì¡´ ë©”ì‹œì§€ ì§€ìš°ê¸°
                    document.getElementById('chatMessages').innerHTML = '';
                    
                    // ë©”ì‹œì§€ í‘œì‹œ (ì˜¤ë˜ëœ ìˆœì„œëŒ€ë¡œ)
                    data.messages.reverse().forEach(message => {
                        displayMessage(message);
                    });
                    
                } else {
                    const errorText = await response.text();
                    log(`ì±„íŒ… ê¸°ë¡ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: ${response.status} ${errorText}`);
                    alert(`ì±„íŒ… ê¸°ë¡ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: ${response.status}`);
                }
            } catch (error) {
                log('ì±„íŒ… ê¸°ë¡ ë¶ˆëŸ¬ì˜¤ê¸° ì—ëŸ¬: ' + error);
                alert('ì±„íŒ… ê¸°ë¡ ë¶ˆëŸ¬ì˜¤ê¸° ì—ëŸ¬: ' + error.message);
            }
        }

        // Enter í‚¤ë¡œ ë©”ì‹œì§€ ì „ì†¡
        document.getElementById('messageInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        // í˜ì´ì§€ ë¡œë“œ ì‹œ
        window.onload = function() {
            log('ì±„íŒ… í…ŒìŠ¤íŠ¸ í˜ì´ì§€ ë¡œë“œë¨');
            log('ì‚¬ìš© ì „ì— JWT í† í°ê³¼ ìŠ¤í„°ë”” IDë¥¼ ì…ë ¥í•˜ì„¸ìš”');
        };

        // í˜ì´ì§€ ì¢…ë£Œ ì‹œ ì—°ê²° í•´ì œ
        window.addEventListener('beforeunload', function() {
            if (stompClient !== null) {
                stompClient.disconnect();
            }
        });
    </script>
</body>
</html>