<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pado ì±„íŒ… í…ŒìŠ¤íŠ¸ (Redis ëª¨ë‹¬ ê´€ë¦¬ + ì•ˆ ì½ì€ ë©¤ë²„ ìˆ˜)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.6.1/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
        }
        .container {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .modal-status {
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 10px;
            font-weight: bold;
        }
        .modal-status.open {
            background-color: #d1ecf1;
            color: #0c5460;
        }
        .modal-status.closed {
            background-color: #f8d7da;
            color: #721c24;
        }
        .chat-messages {
            height: 400px;
            border: 1px solid #ccc;
            padding: 10px;
            overflow-y: scroll;
            margin-bottom: 10px;
            background-color: #f9f9f9;
        }
        .message {
            margin-bottom: 10px;
            padding: 8px;
            border-radius: 4px;
            background-color: white;
            position: relative;
        }
        .message-header {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .message-content {
            font-size: 14px;
        }
        .unread-badge {
            background-color: #ff4444;
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: bold;
            margin-left: 10px;
        }
        .unread-count {
            background-color: #ff4444;
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            margin: 10px 0;
            font-weight: bold;
            display: inline-block;
        }
        .input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }
        .input-group input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }
        .btn-primary {
            background-color: #007bff;
            color: white;
        }
        .btn-success {
            background-color: #28a745;
            color: white;
        }
        .btn-danger {
            background-color: #dc3545;
            color: white;
        }
        .btn-warning {
            background-color: #ffc107;
            color: black;
        }
        .btn-info {
            background-color: #17a2b8;
            color: white;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 10px;
        }
        .status.connected {
            background-color: #d4edda;
            color: #155724;
        }
        .status.disconnected {
            background-color: #f8d7da;
            color: #721c24;
        }
        .logs {
            height: 150px;
            border: 1px solid #ccc;
            padding: 10px;
            overflow-y: scroll;
            background-color: #f8f8f8;
            font-family: monospace;
            font-size: 12px;
        }
        .highlight {
            background-color: yellow;
            padding: 2px 4px;
        }
        .info-box {
            background-color: #e7f3ff;
            border-left: 4px solid #007bff;
            padding: 15px;
            margin: 15px 0;
        }
        .info-box h4 {
            margin-top: 0;
            color: #007bff;
        }
    </style>
</head>
<body>
<h1>ğŸŒŠ Pado ì±„íŒ… í…ŒìŠ¤íŠ¸ (Redis ëª¨ë‹¬ ê´€ë¦¬ + ì•ˆ ì½ì€ ë©¤ë²„ ìˆ˜)</h1>

<div class="container">
    <h2>ì—°ê²° ì„¤ì •</h2>
    <div class="input-group">
        <input type="number" id="studyId" placeholder="ìŠ¤í„°ë”” ID (ì˜ˆ: 1)" value="1">
        <input type="text" id="authToken" placeholder="JWT í† í° (Bearer ì œì™¸)">
    </div>
    <div class="input-group">
        <button class="btn btn-success" onclick="connect()">WebSocket ì—°ê²°</button>
        <button class="btn btn-danger" onclick="disconnect()">ì—°ê²° í•´ì œ</button>
    </div>
    <div id="connectionStatus" class="status disconnected">ì—°ê²°ë˜ì§€ ì•ŠìŒ</div>
</div>

<div class="container">
    <h2>ì±„íŒ… ëª¨ë‹¬ ì œì–´ (Redis)</h2>
    <div class="input-group">
        <button class="btn btn-info" onclick="openModal()">ğŸ“‚ ëª¨ë‹¬ ì—´ê¸°</button>
        <button class="btn btn-warning" onclick="closeModal()">ğŸ“ ëª¨ë‹¬ ë‹«ê¸°</button>
        <button class="btn btn-primary" onclick="loadChatHistory()">ğŸ“‹ ì±„íŒ… ê¸°ë¡</button>
    </div>
    <div id="modalStatus" class="modal-status closed">ëª¨ë‹¬ ìƒíƒœ: ë‹«í˜</div>
    <div id="unreadCount" style="display: none;">
        <span class="unread-count">ì•ˆì½ì€ ë©”ì‹œì§€: 0ê°œ</span>
    </div>
    
    <div class="info-box">
        <h4>âœ¨ ìƒˆë¡œìš´ ê¸°ëŠ¥: ì•ˆ ì½ì€ ë©¤ë²„ ìˆ˜ í‘œì‹œ</h4>
        <p>ê° ë©”ì‹œì§€ ì˜†ì— <span class="unread-badge">3ëª… ì•ˆ ì½ìŒ</span> í˜•íƒœë¡œ í‘œì‹œë©ë‹ˆë‹¤!</p>
        <ul>
            <li>ğŸ’¬ ë©”ì‹œì§€ ì „ì†¡ ì‹œ: ìë™ìœ¼ë¡œ ì•ˆ ì½ì€ ë©¤ë²„ ìˆ˜ í‘œì‹œ</li>
            <li>ğŸ“– ë‹¤ë¥¸ ì‚¬ìš©ìê°€ ì½ìœ¼ë©´: ì‹¤ì‹œê°„ìœ¼ë¡œ ìˆ«ì ê°ì†Œ</li>
            <li>ğŸ“‹ ì±„íŒ… ê¸°ë¡ ë¶ˆëŸ¬ì˜¤ê¸°: í˜„ì¬ ì‹œì ì˜ ì•ˆ ì½ì€ ë©¤ë²„ ìˆ˜ í‘œì‹œ</li>
        </ul>
    </div>
    
    <p style="font-size: 14px; color: #666; margin-top: 10px;">
        ğŸ’¡ ëª¨ë‹¬ì´ ë‹«íŒ ìƒíƒœì—ì„œ ë©”ì‹œì§€ê°€ ì˜¤ë©´ ì•ˆì½ì€ ë©”ì‹œì§€ ìˆ˜ê°€ ìë™ìœ¼ë¡œ í‘œì‹œë©ë‹ˆë‹¤.
    </p>
    <p style="font-size: 12px; color: #666;">
        ğŸ’¡ ëª¨ë‹¬ì„ ì—´ë©´ ìë™ìœ¼ë¡œ ìµœì‹  ë©”ì‹œì§€ê¹Œì§€ ì½ìŒ ì²˜ë¦¬ë©ë‹ˆë‹¤.<br>
        ğŸ’¡ ëª¨ë‹¬ì„ ì—´ë©´ Heartbeatê°€ ìë™ìœ¼ë¡œ ì „ì†¡ë©ë‹ˆë‹¤ (4ë¶„ë§ˆë‹¤).
    </p>
</div>

<div class="container">
    <h2>ì±„íŒ…</h2>
    <div id="chatMessages" class="chat-messages"></div>
    <div class="input-group">
        <input type="text" id="messageInput" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." maxlength="1000">
        <button class="btn btn-primary" onclick="sendMessage()">ì „ì†¡</button>
    </div>
</div>

<div class="container">
    <h2>ë¡œê·¸</h2>
    <div id="logs" class="logs"></div>
    <button class="btn btn-primary" onclick="clearLogs()">ë¡œê·¸ ì§€ìš°ê¸°</button>
</div>

<div class="container">
    <h2>ë™ì‘ ë°©ì‹</h2>
    <ol>
        <li><strong>WebSocket ì—°ê²°:</strong> "WebSocket ì—°ê²°" ë²„íŠ¼ìœ¼ë¡œ ì„œë²„ì™€ ì—°ê²°</li>
        <li><strong>ëª¨ë‹¬ ì—´ê¸°:</strong> "ëª¨ë‹¬ ì—´ê¸°" ë²„íŠ¼ í´ë¦­ â†’ Redisì— ìƒíƒœ ì €ì¥ + ì½ìŒ ì²˜ë¦¬</li>
        <li><strong>ë©”ì‹œì§€ ì „ì†¡:</strong> ì±„íŒ… ì…ë ¥ í›„ "ì „ì†¡" ë²„íŠ¼ í´ë¦­</li>
        <li><strong>ëª¨ë‹¬ ë‹«ê¸°:</strong> "ëª¨ë‹¬ ë‹«ê¸°" ë²„íŠ¼ í´ë¦­ â†’ Redisì—ì„œ ìƒíƒœ ì‚­ì œ</li>
        <li><strong>ì•ˆì½ì€ ë©”ì‹œì§€:</strong> ëª¨ë‹¬ì´ ë‹«íŒ ìƒíƒœì—ì„œ ë©”ì‹œì§€ê°€ ì˜¤ë©´ ìë™ìœ¼ë¡œ ì•Œë¦¼</li>
        <li><strong>ì•ˆ ì½ì€ ë©¤ë²„ ìˆ˜:</strong> ê° ë©”ì‹œì§€ ì˜†ì— ì‹¤ì‹œê°„ìœ¼ë¡œ í‘œì‹œ</li>
    </ol>

    <h3>Redis ê¸°ë°˜ ëª¨ë‹¬ ê´€ë¦¬ íŠ¹ì§•</h3>
    <ul>
        <li>âœ… Redisì— "chat:modal:{studyId}:{userId}" í‚¤ë¡œ ëª¨ë‹¬ ìƒíƒœ ì €ì¥</li>
        <li>âœ… TTL 5ë¶„ ì„¤ì • (ìë™ ë§Œë£Œ)</li>
        <li>âœ… Heartbeatë¡œ 4ë¶„ë§ˆë‹¤ TTL ê°±ì‹  (ëª¨ë‹¬ ì—´ë ¤ìˆëŠ” ë™ì•ˆ)</li>
        <li>âœ… ë©€í‹° ì„œë²„ í™˜ê²½ì—ì„œë„ ë™ì¼í•œ ìƒíƒœ ê³µìœ </li>
        <li>âœ… ëª¨ë‹¬ ì—´ë¦° ì‚¬ìš©ì: ë©”ì‹œì§€ ìë™ ì½ìŒ ì²˜ë¦¬</li>
        <li>âœ… ëª¨ë‹¬ ë‹«íŒ ì‚¬ìš©ì: ì•ˆì½ì€ ë©”ì‹œì§€ ìˆ˜ ì•Œë¦¼ ìˆ˜ì‹  (ìë™)</li>
        <li>âœ¨ <strong>ì•ˆ ì½ì€ ë©¤ë²„ ìˆ˜ ì‹¤ì‹œê°„ í‘œì‹œ (ì¹´ì¹´ì˜¤í†¡ ìŠ¤íƒ€ì¼)</strong></li>
    </ul>

    <h3>í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤</h3>
    <ol>
        <li><strong>ë‹¨ì¼ ì‚¬ìš©ì:</strong>
            <ul>
                <li>ëª¨ë‹¬ ì—´ê¸° â†’ ë©”ì‹œì§€ ì „ì†¡ â†’ ìë™ ì½ìŒ ì²˜ë¦¬ í™•ì¸</li>
                <li>ëª¨ë‹¬ ë‹«ê¸° â†’ ë‹¤ë¥¸ íƒ­ì—ì„œ ë©”ì‹œì§€ ì „ì†¡ â†’ ì•ˆì½ì€ ìˆ˜ ì•Œë¦¼ í™•ì¸</li>
            </ul>
        </li>
        <li><strong>ì—¬ëŸ¬ ì‚¬ìš©ì (ë‹¤ë¥¸ ë¸Œë¼ìš°ì €/íƒ­):</strong>
            <ul>
                <li>ì‚¬ìš©ì A: ëª¨ë‹¬ ì—´ê³  ìˆìŒ</li>
                <li>ì‚¬ìš©ì B: ëª¨ë‹¬ ë‹«ê³  ìˆìŒ</li>
                <li>ì‚¬ìš©ì C: ë©”ì‹œì§€ ì „ì†¡</li>
                <li>ê²°ê³¼: AëŠ” ìë™ ì½ìŒ, BëŠ” ì•ˆì½ì€ ë©”ì‹œì§€ ìˆ˜ ì•Œë¦¼, ë©”ì‹œì§€ ì˜†ì— "1ëª… ì•ˆ ì½ìŒ" í‘œì‹œ</li>
            </ul>
        </li>
        <li><strong>ì•ˆ ì½ì€ ë©¤ë²„ ìˆ˜ í…ŒìŠ¤íŠ¸:</strong>
            <ul>
                <li>ì—¬ëŸ¬ íƒ­ì—ì„œ ì„œë¡œ ë‹¤ë¥¸ ì‚¬ìš©ìë¡œ ì ‘ì†</li>
                <li>ì¼ë¶€ëŠ” ëª¨ë‹¬ ì—´ê¸°, ì¼ë¶€ëŠ” ëª¨ë‹¬ ë‹«ê¸°</li>
                <li>ë©”ì‹œì§€ ì „ì†¡ í›„ ì•ˆ ì½ì€ ë©¤ë²„ ìˆ˜ í™•ì¸</li>
                <li>ë‹¤ë¥¸ ì‚¬ìš©ìê°€ ëª¨ë‹¬ì„ ì—´ë©´ ìˆ«ìê°€ ì‹¤ì‹œê°„ìœ¼ë¡œ ê°ì†Œí•˜ëŠ”ì§€ í™•ì¸</li>
            </ul>
        </li>
    </ol>

    <p><strong>API ì—”ë“œí¬ì¸íŠ¸:</strong></p>
    <ul>
        <li>WebSocket: <code>http://localhost:8080/ws</code> (SockJS)</li>
        <li>ì±„íŒ… ê¸°ë¡: <code>GET /api/studies/{studyId}/chats</code></li>
    </ul>

    <p><strong>WebSocket ë©”ì‹œì§€:</strong></p>
    <ul>
        <li>ë©”ì‹œì§€ ì „ì†¡: <code>/app/studies/{studyId}/chats</code></li>
        <li>ëª¨ë‹¬ ì—´ê¸°: <code>/app/studies/{studyId}/modal/open</code></li>
        <li>ëª¨ë‹¬ ë‹«ê¸°: <code>/app/studies/{studyId}/modal/close</code></li>
        <li>Heartbeat: <code>/app/studies/{studyId}/modal/heartbeat</code></li>
    </ul>

    <p><strong>WebSocket êµ¬ë…:</strong></p>
    <ul>
        <li>ì±„íŒ… ë©”ì‹œì§€: <code>/topic/studies/{studyId}/chats</code> (unreadMemberCount í¬í•¨)</li>
        <li>ì½ìŒ ìƒíƒœ ì—…ë°ì´íŠ¸: <code>/topic/studies/{studyId}/unread</code> (lastReadMessageId)</li>
        <li>ì•ˆì½ì€ ë©”ì‹œì§€ ìˆ˜: <code>/user/queue/studies/{studyId}/unread</code> (ê°œì¸ ë©”ì‹œì§€, ìë™)</li>
    </ul>
</div>

<script>
    let stompClient = null;
    let currentStudyId = null;
    let isModalOpen = false;
    let heartbeatInterval = null;
    let messageMap = new Map(); // messageId -> DOM element ë§¤í•‘

    function log(message, highlight = false) {
        const logs = document.getElementById('logs');
        const timestamp = new Date().toLocaleTimeString();
        const className = highlight ? 'class="highlight"' : '';
        logs.innerHTML += `<span ${className}>[${timestamp}] ${message}</span>\n`;
        logs.scrollTop = logs.scrollHeight;
    }

    function clearLogs() {
        document.getElementById('logs').innerHTML = '';
    }

    function updateConnectionStatus(connected) {
        const status = document.getElementById('connectionStatus');
        if (connected) {
            status.className = 'status connected';
            status.textContent = `ìŠ¤í„°ë”” ${currentStudyId} WebSocket ì—°ê²°ë¨ (SockJS + Redis)`;
        } else {
            status.className = 'status disconnected';
            status.textContent = 'ì—°ê²°ë˜ì§€ ì•ŠìŒ';
        }
    }

    function updateModalStatus(open) {
        isModalOpen = open;
        const status = document.getElementById('modalStatus');
        if (open) {
            status.className = 'modal-status open';
            status.textContent = 'ëª¨ë‹¬ ìƒíƒœ: ì—´ë¦¼ (Redisì— ì €ì¥ë¨)';
        } else {
            status.className = 'modal-status closed';
            status.textContent = 'ëª¨ë‹¬ ìƒíƒœ: ë‹«í˜ (Redisì—ì„œ ì‚­ì œë¨)';
        }
    }

    function updateUnreadCount(count) {
        const unreadDiv = document.getElementById('unreadCount');
        if (count > 0) {
            unreadDiv.innerHTML = `<span class="unread-count">ì•ˆì½ì€ ë©”ì‹œì§€: ${count}ê°œ</span>`;
            unreadDiv.style.display = 'block';
        } else {
            unreadDiv.style.display = 'none';
        }
    }

    function startHeartbeat() {
        if (heartbeatInterval) {
            clearInterval(heartbeatInterval);
        }

        // 4ë¶„ë§ˆë‹¤ heartbeat ì „ì†¡ (TTLì´ 5ë¶„ì´ë¯€ë¡œ)
        heartbeatInterval = setInterval(() => {
            if (stompClient && stompClient.connected && isModalOpen) {
                stompClient.send(`/app/studies/${currentStudyId}/modal/heartbeat`, {}, JSON.stringify({}));
                log('ğŸ’“ Heartbeat ì „ì†¡ (Redis TTL ê°±ì‹ )');
            }
        }, 240000); // 4ë¶„
    }

    function stopHeartbeat() {
        if (heartbeatInterval) {
            clearInterval(heartbeatInterval);
            heartbeatInterval = null;
            log('ğŸ’” Heartbeat ì¤‘ì§€');
        }
    }

    function connect() {
        const studyId = document.getElementById('studyId').value;
        const authToken = document.getElementById('authToken').value;

        if (!studyId) {
            alert('ìŠ¤í„°ë”” IDë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”');
            return;
        }

        if (!authToken) {
            alert('JWT í† í°ì„ ì…ë ¥í•´ì£¼ì„¸ìš”');
            return;
        }

        currentStudyId = studyId;

        log('ğŸ”Œ SockJS + WebSocket ì—°ê²° ì‹œë„...');

        const socket = new SockJS('/ws');
        stompClient = Stomp.over(socket);

        const headers = {
            'Authorization': `Bearer ${authToken}`
        };

        stompClient.connect(headers, function(frame) {
            log('âœ… WebSocket ì—°ê²° ì„±ê³µ!');
            updateConnectionStatus(true);

            // ì±„íŒ… ë©”ì‹œì§€ êµ¬ë…
            stompClient.subscribe(`/topic/studies/${studyId}/chats`, function(message) {
                const chatMessage = JSON.parse(message.body);
                displayMessage(chatMessage);
                log(`ğŸ’¬ ì±„íŒ… ë©”ì‹œì§€ ìˆ˜ì‹ : ${chatMessage.senderName} (ì•ˆ ì½ì€ ë©¤ë²„: ${chatMessage.unreadMemberCount}ëª…)`);
            });

            // ì½ìŒ ìƒíƒœ ì—…ë°ì´íŠ¸ êµ¬ë… (ëˆ„êµ°ê°€ ëª¨ë‹¬ì„ ì—´ì—ˆì„ ë•Œ)
            stompClient.subscribe(`/topic/studies/${studyId}/unread`, function(message) {
                const readData = JSON.parse(message.body);
                updateUnreadCountForMessagesAfter(readData.lastReadMessageId);
                log(`ğŸ“– ì½ìŒ ìƒíƒœ ì—…ë°ì´íŠ¸: messageId ${readData.lastReadMessageId} ì´í›„ ë©”ì‹œì§€ ì—…ë°ì´íŠ¸`, true);
            });

            // ì•ˆì½ì€ ë©”ì‹œì§€ ìˆ˜ êµ¬ë… (ê°œì¸ ë©”ì‹œì§€)
            stompClient.subscribe(`/user/queue/studies/${studyId}/unread`, function(message) {
                const unreadData = JSON.parse(message.body);
                updateUnreadCount(unreadData.unreadCount);
                log(`ğŸ”” ì•ˆì½ì€ ë©”ì‹œì§€ ìˆ˜ ìë™ ìˆ˜ì‹ : ${unreadData.unreadCount}ê°œ`, true);
            });

            // ì—ëŸ¬ ë©”ì‹œì§€ êµ¬ë…
            stompClient.subscribe('/user/queue/errors', function(message) {
                const error = JSON.parse(message.body);
                log('âŒ ì—ëŸ¬: ' + JSON.stringify(error), true);
                alert(`ì—ëŸ¬: ${error.message}`);
            });

            log(`ğŸ“¡ ìŠ¤í„°ë”” ${studyId} êµ¬ë… ì™„ë£Œ (ì±„íŒ…, ì½ìŒ ìƒíƒœ, ì•ˆì½ì€ ìˆ˜)`);

        }, function(error) {
            log('âŒ WebSocket ì—°ê²° ì‹¤íŒ¨: ' + error, true);
            updateConnectionStatus(false);
            alert('ì—°ê²° ì‹¤íŒ¨: ' + error);
        });
    }

    function disconnect() {
        if (isModalOpen) {
            closeModal();
        }

        if (stompClient !== null) {
            stompClient.disconnect();
            log('ğŸ”Œ WebSocket ì—°ê²° í•´ì œ');
        }
        updateConnectionStatus(false);
        stopHeartbeat();
        currentStudyId = null;
        messageMap.clear();
    }

    function openModal() {
        if (!stompClient || !stompClient.connected) {
            alert('ë¨¼ì € WebSocketì— ì—°ê²°í•´ì£¼ì„¸ìš”');
            return;
        }

        log('ğŸ“‚ ëª¨ë‹¬ ì—´ê¸° ìš”ì²­...');
        stompClient.send(`/app/studies/${currentStudyId}/modal/open`, {}, JSON.stringify({}));
        updateModalStatus(true);
        updateUnreadCount(0); // ëª¨ë‹¬ ì—´ë©´ ì•ˆì½ì€ ë©”ì‹œì§€ 0ìœ¼ë¡œ ì´ˆê¸°í™”
        startHeartbeat();
        log('âœ… ëª¨ë‹¬ ì—´ë¦¼ + Redis ì €ì¥ + Heartbeat ì‹œì‘ + ì•ˆì½ì€ ë©”ì‹œì§€ ì´ˆê¸°í™”', true);
    }

    function closeModal() {
        if (!stompClient || !stompClient.connected) {
            alert('ë¨¼ì € WebSocketì— ì—°ê²°í•´ì£¼ì„¸ìš”');
            return;
        }

        log('ğŸ“ ëª¨ë‹¬ ë‹«ê¸° ìš”ì²­...');
        stompClient.send(`/app/studies/${currentStudyId}/modal/close`, {}, JSON.stringify({}));
        updateModalStatus(false);
        stopHeartbeat();
        log('âœ… ëª¨ë‹¬ ë‹«í˜ + Redis ì‚­ì œ', true);
    }

    function sendMessage() {
        const messageInput = document.getElementById('messageInput');
        const content = messageInput.value.trim();

        if (!content) {
            alert('ë©”ì‹œì§€ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”');
            return;
        }

        if (!stompClient || !stompClient.connected) {
            alert('ë¨¼ì € WebSocketì— ì—°ê²°í•´ì£¼ì„¸ìš”');
            return;
        }

        const message = {
            content: content
        };

        log(`ğŸ“¤ ë©”ì‹œì§€ ì „ì†¡: ${content}`);
        stompClient.send(`/app/studies/${currentStudyId}/chats`, {}, JSON.stringify(message));
        messageInput.value = '';
    }

    function displayMessage(message) {
        const chatMessages = document.getElementById('chatMessages');
        const messageDiv = document.createElement('div');
        messageDiv.className = 'message';
        messageDiv.dataset.messageId = message.messageId;

        const timestamp = new Date(message.createdAt).toLocaleString();
        
        // ì•ˆ ì½ì€ ë©¤ë²„ ìˆ˜ í‘œì‹œ
        const unreadBadge = message.unreadMemberCount > 0 
            ? `<span class="unread-badge" data-message-id="${message.messageId}">${message.unreadMemberCount}ëª… ì•ˆ ì½ìŒ</span>`
            : '';

        messageDiv.innerHTML = `
            <div class="message-header">
                <div>
                    <strong>${message.senderName}</strong> - ${timestamp}
                </div>
                ${unreadBadge}
            </div>
            <div class="message-content">${escapeHtml(message.content)}</div>
        `;

        chatMessages.appendChild(messageDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
        
        // Mapì— ì €ì¥
        messageMap.set(message.messageId, messageDiv);
    }

    function updateUnreadCountForMessagesAfter(previousLastReadMessageId) {
        // previousLastReadMessageId ì´ˆê³¼(>) ë©”ì‹œì§€ë§Œ unreadCountë¥¼ -1
        messageMap.forEach((messageDiv, messageId) => {
            if (messageId > previousLastReadMessageId) {
                const badge = messageDiv.querySelector('.unread-badge');
                if (badge) {
                    const currentCount = parseInt(badge.textContent);
                    const newCount = Math.max(0, currentCount - 1);
                    
                    if (newCount === 0) {
                        // 0ì´ ë˜ë©´ ë°°ì§€ ì œê±°
                        badge.remove();
                    } else {
                        badge.textContent = `${newCount}ëª… ì•ˆ ì½ìŒ`;
                    }
                }
            }
        });
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    async function loadChatHistory() {
        const authToken = document.getElementById('authToken').value;
        const studyId = document.getElementById('studyId').value;

        if (!authToken || !studyId) {
            alert('ìŠ¤í„°ë”” IDì™€ JWT í† í°ì„ ì…ë ¥í•´ì£¼ì„¸ìš”');
            return;
        }

        try {
            log('ğŸ“‹ ì±„íŒ… ê¸°ë¡ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...');

            const response = await fetch(`/api/studies/${studyId}/chats?size=50`, {
                headers: {
                    'Authorization': `Bearer ${authToken}`,
                    'Content-Type': 'application/json'
                }
            });

            if (response.ok) {
                const data = await response.json();
                log(`âœ… ì±„íŒ… ê¸°ë¡ ${data.messages.length}ê°œ ë¶ˆëŸ¬ì˜´ (ì•ˆ ì½ì€ ë©¤ë²„ ìˆ˜ í¬í•¨)`);

                document.getElementById('chatMessages').innerHTML = '';
                messageMap.clear();

                data.messages.reverse().forEach(message => {
                    displayMessage(message);
                });

            } else {
                const errorText = await response.text();
                log(`âŒ ì±„íŒ… ê¸°ë¡ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: ${response.status}`, true);
                alert(`ì±„íŒ… ê¸°ë¡ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: ${response.status}`);
            }
        } catch (error) {
            log('âŒ ì±„íŒ… ê¸°ë¡ ë¶ˆëŸ¬ì˜¤ê¸° ì—ëŸ¬: ' + error, true);
            alert('ì±„íŒ… ê¸°ë¡ ë¶ˆëŸ¬ì˜¤ê¸° ì—ëŸ¬: ' + error.message);
        }
    }

    // Enter í‚¤ë¡œ ë©”ì‹œì§€ ì „ì†¡
    document.getElementById('messageInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            sendMessage();
        }
    });

    // í˜ì´ì§€ ë¡œë“œ ì‹œ
    window.onload = function() {
        log('ğŸŒŠ Pado ì±„íŒ… í…ŒìŠ¤íŠ¸ í˜ì´ì§€ ë¡œë“œë¨ (Redis ëª¨ë‹¬ ê´€ë¦¬ + ì•ˆ ì½ì€ ë©¤ë²„ ìˆ˜)');
        log('ğŸ“ ì‚¬ìš© ì „ì— JWT í† í°ê³¼ ìŠ¤í„°ë”” IDë¥¼ ì…ë ¥í•˜ì„¸ìš”');
        log('ğŸ’¡ ëª¨ë‹¬ì´ ë‹«íŒ ìƒíƒœì—ì„œ ë©”ì‹œì§€ê°€ ì˜¤ë©´ ì•ˆì½ì€ ë©”ì‹œì§€ ìˆ˜ê°€ ìë™ìœ¼ë¡œ í‘œì‹œë©ë‹ˆë‹¤!');
        log('âœ¨ ê° ë©”ì‹œì§€ ì˜†ì— ì•ˆ ì½ì€ ë©¤ë²„ ìˆ˜ê°€ ì‹¤ì‹œê°„ìœ¼ë¡œ í‘œì‹œë©ë‹ˆë‹¤!');
    };

    // í˜ì´ì§€ ì¢…ë£Œ ì‹œ ì—°ê²° í•´ì œ
    window.addEventListener('beforeunload', function() {
        if (isModalOpen) {
            closeModal();
        }
        if (stompClient !== null) {
            stompClient.disconnect();
        }
        stopHeartbeat();
    });
</script>
</body>
</html>