<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pado ì±„íŒ… í…ŒìŠ¤íŠ¸ (ë¦¬ì•¡ì…˜ + ì‚­ì œ)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.6.1/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
        }
        .container {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .modal-status {
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 10px;
            font-weight: bold;
        }
        .modal-status.open {
            background-color: #d1ecf1;
            color: #0c5460;
        }
        .modal-status.closed {
            background-color: #f8d7da;
            color: #721c24;
        }
        .chat-messages {
            height: 400px;
            border: 1px solid #ccc;
            padding: 10px;
            overflow-y: scroll;
            margin-bottom: 10px;
            background-color: #f9f9f9;
        }
        .message {
            margin-bottom: 10px;
            padding: 8px;
            border-radius: 4px;
            background-color: white;
            position: relative;
        }
        .message.deleted {
            background-color: #f0f0f0;
            opacity: 0.5;
        }
        .message-header {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .message-content {
            font-size: 14px;
            margin-bottom: 8px;
        }
        .message-actions {
            display: flex;
            gap: 5px;
            align-items: center;
            margin-top: 8px;
        }
        .reaction-btn {
            padding: 4px 8px;
            border: 1px solid #ddd;
            border-radius: 12px;
            background-color: white;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }
        .reaction-btn:hover {
            background-color: #f0f0f0;
        }
        .reaction-btn.active {
            background-color: #007bff;
            color: white;
            border-color: #007bff;
        }
        .reaction-count {
            font-size: 12px;
            color: #666;
            margin-left: 2px;
        }
        .delete-btn {
            padding: 4px 8px;
            border: 1px solid #dc3545;
            border-radius: 4px;
            background-color: white;
            color: #dc3545;
            cursor: pointer;
            font-size: 12px;
            margin-left: auto;
        }
        .delete-btn:hover {
            background-color: #dc3545;
            color: white;
        }
        .unread-badge {
            background-color: #ff4444;
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: bold;
            margin-left: 10px;
        }
        .unread-count {
            background-color: #ff4444;
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            margin: 10px 0;
            font-weight: bold;
            display: inline-block;
        }
        .input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }
        .input-group input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }
        .btn-primary {
            background-color: #007bff;
            color: white;
        }
        .btn-success {
            background-color: #28a745;
            color: white;
        }
        .btn-danger {
            background-color: #dc3545;
            color: white;
        }
        .btn-warning {
            background-color: #ffc107;
            color: black;
        }
        .btn-info {
            background-color: #17a2b8;
            color: white;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 10px;
        }
        .status.connected {
            background-color: #d4edda;
            color: #155724;
        }
        .status.disconnected {
            background-color: #f8d7da;
            color: #721c24;
        }
        .logs {
            height: 150px;
            border: 1px solid #ccc;
            padding: 10px;
            overflow-y: scroll;
            background-color: #f8f8f8;
            font-family: monospace;
            font-size: 12px;
        }
        .highlight {
            background-color: yellow;
            padding: 2px 4px;
        }
        .info-box {
            background-color: #e7f3ff;
            border-left: 4px solid #007bff;
            padding: 15px;
            margin: 15px 0;
        }
        .info-box h4 {
            margin-top: 0;
            color: #007bff;
        }
        .new-feature {
            background-color: #d4edda;
            border-left: 4px solid #28a745;
        }
    </style>
</head>
<body>
<h1>ğŸŒŠ Pado ì±„íŒ… í…ŒìŠ¤íŠ¸ (ë¦¬ì•¡ì…˜ + ì‚­ì œ)</h1>

<div class="container">
    <h2>ì—°ê²° ì„¤ì •</h2>
    <div class="input-group">
        <input type="number" id="studyId" placeholder="ìŠ¤í„°ë”” ID (ì˜ˆ: 1)" value="1">
        <input type="text" id="authToken" placeholder="JWT í† í° (Bearer ì œì™¸)">
    </div>
    <div class="input-group">
        <button class="btn btn-success" onclick="connect()">WebSocket ì—°ê²°</button>
        <button class="btn btn-danger" onclick="disconnect()">ì—°ê²° í•´ì œ</button>
    </div>
    <div id="connectionStatus" class="status disconnected">ì—°ê²°ë˜ì§€ ì•ŠìŒ</div>
</div>

<div class="container">
    <h2>ì±„íŒ… ëª¨ë‹¬ ì œì–´</h2>
    <div class="input-group">
        <button class="btn btn-info" onclick="openModal()">ğŸ“‚ ëª¨ë‹¬ ì—´ê¸°</button>
        <button class="btn btn-warning" onclick="closeModal()">ğŸ“ ëª¨ë‹¬ ë‹«ê¸°</button>
        <button class="btn btn-primary" onclick="loadChatHistory()">ğŸ“‹ ì±„íŒ… ê¸°ë¡</button>
    </div>
    <div id="modalStatus" class="modal-status closed">ëª¨ë‹¬ ìƒíƒœ: ë‹«í˜</div>
    <div id="unreadCount" style="display: none;">
        <span class="unread-count">ì•ˆì½ì€ ë©”ì‹œì§€: 0ê°œ</span>
    </div>
    
    <div class="info-box new-feature">
        <h4>ğŸ‰ ìƒˆë¡œìš´ ê¸°ëŠ¥: ì¢‹ì•„ìš”/ì‹«ì–´ìš” & ë©”ì‹œì§€ ì‚­ì œ</h4>
        <ul>
            <li>ğŸ‘ <strong>ì¢‹ì•„ìš”/ì‹«ì–´ìš”:</strong> ê° ë©”ì‹œì§€ì— ë¦¬ì•¡ì…˜ ì¶”ê°€ ê°€ëŠ¥</li>
            <li>ğŸ”„ <strong>ì‹¤ì‹œê°„ ì¹´ìš´íŠ¸:</strong> ë¦¬ì•¡ì…˜ ìˆ˜ê°€ ì‹¤ì‹œê°„ìœ¼ë¡œ ì—…ë°ì´íŠ¸ë¨</li>
            <li>ğŸ—‘ï¸ <strong>ë©”ì‹œì§€ ì‚­ì œ:</strong> ë³¸ì¸ì´ ì‘ì„±í•œ ë©”ì‹œì§€ ì‚­ì œ ê°€ëŠ¥</li>
            <li>ğŸ“¡ <strong>ì›¹ì†Œì¼“ ì•Œë¦¼:</strong> ëª¨ë“  ë³€ê²½ì‚¬í•­ì´ ì‹¤ì‹œê°„ ë°˜ì˜</li>
        </ul>
    </div>
</div>

<div class="container">
    <h2>ì±„íŒ…</h2>
    <div id="chatMessages" class="chat-messages"></div>
    <div class="input-group">
        <input type="text" id="messageInput" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." maxlength="1000">
        <button class="btn btn-primary" onclick="sendMessage()">ì „ì†¡</button>
    </div>
</div>

<div class="container">
    <h2>ë¡œê·¸</h2>
    <div id="logs" class="logs"></div>
    <button class="btn btn-primary" onclick="clearLogs()">ë¡œê·¸ ì§€ìš°ê¸°</button>
</div>

<script>
    let stompClient = null;
    let currentStudyId = null;
    let currentUserId = null;
    let isModalOpen = false;
    let heartbeatInterval = null;
    let messageMap = new Map();
    let userReactions = new Map();

    function log(message, highlight = false) {
        const logs = document.getElementById('logs');
        const timestamp = new Date().toLocaleTimeString();
        const className = highlight ? 'class="highlight"' : '';
        logs.innerHTML += `<span ${className}>[${timestamp}] ${message}</span>\n`;
        logs.scrollTop = logs.scrollHeight;
    }

    function clearLogs() {
        document.getElementById('logs').innerHTML = '';
    }

    function updateConnectionStatus(connected) {
        const status = document.getElementById('connectionStatus');
        if (connected) {
            status.className = 'status connected';
            status.textContent = `ìŠ¤í„°ë”” ${currentStudyId} WebSocket ì—°ê²°ë¨`;
        } else {
            status.className = 'status disconnected';
            status.textContent = 'ì—°ê²°ë˜ì§€ ì•ŠìŒ';
        }
    }

    function updateModalStatus(open) {
        isModalOpen = open;
        const status = document.getElementById('modalStatus');
        if (open) {
            status.className = 'modal-status open';
            status.textContent = 'ëª¨ë‹¬ ìƒíƒœ: ì—´ë¦¼';
        } else {
            status.className = 'modal-status closed';
            status.textContent = 'ëª¨ë‹¬ ìƒíƒœ: ë‹«í˜';
        }
    }

    function updateUnreadCount(count) {
        const unreadDiv = document.getElementById('unreadCount');
        if (count > 0) {
            unreadDiv.innerHTML = `<span class="unread-count">ì•ˆì½ì€ ë©”ì‹œì§€: ${count}ê°œ</span>`;
            unreadDiv.style.display = 'block';
        } else {
            unreadDiv.style.display = 'none';
        }
    }

    function startHeartbeat() {
        if (heartbeatInterval) {
            clearInterval(heartbeatInterval);
        }
        heartbeatInterval = setInterval(() => {
            if (stompClient && stompClient.connected && isModalOpen) {
                stompClient.send(`/app/studies/${currentStudyId}/modal/heartbeat`, {}, JSON.stringify({}));
                log('ğŸ’“ Heartbeat ì „ì†¡');
            }
        }, 240000);
    }

    function stopHeartbeat() {
        if (heartbeatInterval) {
            clearInterval(heartbeatInterval);
            heartbeatInterval = null;
        }
    }

    function connect() {
        const studyId = document.getElementById('studyId').value;
        const authToken = document.getElementById('authToken').value;

        if (!studyId || !authToken) {
            alert('ìŠ¤í„°ë”” IDì™€ JWT í† í°ì„ ì…ë ¥í•´ì£¼ì„¸ìš”');
            return;
        }

        currentStudyId = studyId;
        log('ğŸ”Œ WebSocket ì—°ê²° ì‹œë„...');

        const socket = new SockJS('/ws');
        stompClient = Stomp.over(socket);

        const headers = {
            'Authorization': `Bearer ${authToken}`
        };

        stompClient.connect(headers, function(frame) {
            log('âœ… WebSocket ì—°ê²° ì„±ê³µ!');
            updateConnectionStatus(true);

            stompClient.subscribe(`/topic/studies/${studyId}/chats`, function(message) {
                const chatMessage = JSON.parse(message.body);
                
                // ë‚´ê°€ ë³´ë‚¸ ë©”ì‹œì§€ë©´ currentUserId ì„¤ì •
                if (!currentUserId && chatMessage.senderId) {
                    // ì¼ë‹¨ ì €ì¥ (ë‚˜ì¤‘ì— ë¹„êµìš©)
                    if (!window.recentSenderId) {
                        window.recentSenderId = chatMessage.senderId;
                        currentUserId = chatMessage.senderId;
                        log(`âœ… í˜„ì¬ ì‚¬ìš©ì ID ìë™ ì„¤ì •: ${currentUserId}`);
                    }
                }
                
                displayMessage(chatMessage);
                log(`ğŸ’¬ ì±„íŒ… ë©”ì‹œì§€ ìˆ˜ì‹ : ${chatMessage.senderName}`);
            });

            stompClient.subscribe(`/topic/studies/${studyId}/updates`, function(message) {
                const update = JSON.parse(message.body);
                handleChatUpdate(update);
            });

            stompClient.subscribe(`/topic/studies/${studyId}/unread`, function(message) {
                const readData = JSON.parse(message.body);
                updateUnreadCountForMessagesAfter(readData.lastReadMessageId);
                log(`ğŸ“– ì½ìŒ ìƒíƒœ ì—…ë°ì´íŠ¸`);
            });

            stompClient.subscribe(`/user/queue/studies/${studyId}/unread`, function(message) {
                const unreadData = JSON.parse(message.body);
                updateUnreadCount(unreadData.unreadCount);
                log(`ğŸ”” ì•ˆì½ì€ ë©”ì‹œì§€: ${unreadData.unreadCount}ê°œ`, true);
            });

            stompClient.subscribe('/user/queue/errors', function(message) {
                const error = JSON.parse(message.body);
                log('âŒ ì—ëŸ¬: ' + JSON.stringify(error), true);
                alert(`ì—ëŸ¬: ${error.message}`);
            });

            log(`ğŸ“¡ ìŠ¤í„°ë”” ${studyId} êµ¬ë… ì™„ë£Œ`);
            fetchCurrentUserId(authToken);

        }, function(error) {
            log('âŒ WebSocket ì—°ê²° ì‹¤íŒ¨: ' + error, true);
            updateConnectionStatus(false);
        });
    }

    async function fetchCurrentUserId(authToken) {
        try {
            const response = await fetch('/api/users/me', {
                headers: {
                    'Authorization': `Bearer ${authToken}`
                }
            });
            if (response.ok) {
                const user = await response.json();
                currentUserId = user.userId;
                log(`âœ… í˜„ì¬ ì‚¬ìš©ì ID: ${currentUserId}`);
            }
        } catch (error) {
            log('âš ï¸ ì‚¬ìš©ì ID ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨ (ì‚­ì œ ë²„íŠ¼ì´ í‘œì‹œë˜ì§€ ì•ŠìŠµë‹ˆë‹¤)');
        }
    }

    function disconnect() {
        if (isModalOpen) {
            closeModal();
        }
        if (stompClient !== null) {
            stompClient.disconnect();
            log('ğŸ”Œ WebSocket ì—°ê²° í•´ì œ');
        }
        updateConnectionStatus(false);
        stopHeartbeat();
        currentStudyId = null;
        currentUserId = null;
        messageMap.clear();
        userReactions.clear();
    }

    function openModal() {
        if (!stompClient || !stompClient.connected) {
            alert('ë¨¼ì € WebSocketì— ì—°ê²°í•´ì£¼ì„¸ìš”');
            return;
        }
        log('ğŸ“‚ ëª¨ë‹¬ ì—´ê¸° ìš”ì²­...');
        stompClient.send(`/app/studies/${currentStudyId}/modal/open`, {}, JSON.stringify({}));
        updateModalStatus(true);
        updateUnreadCount(0);
        startHeartbeat();
        log('âœ… ëª¨ë‹¬ ì—´ë¦¼', true);
    }

    function closeModal() {
        if (!stompClient || !stompClient.connected) {
            alert('ë¨¼ì € WebSocketì— ì—°ê²°í•´ì£¼ì„¸ìš”');
            return;
        }
        log('ğŸ“ ëª¨ë‹¬ ë‹«ê¸° ìš”ì²­...');
        stompClient.send(`/app/studies/${currentStudyId}/modal/close`, {}, JSON.stringify({}));
        updateModalStatus(false);
        stopHeartbeat();
        log('âœ… ëª¨ë‹¬ ë‹«í˜', true);
    }

    function sendMessage() {
        const messageInput = document.getElementById('messageInput');
        const content = messageInput.value.trim();

        if (!content) {
            alert('ë©”ì‹œì§€ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”');
            return;
        }

        if (!stompClient || !stompClient.connected) {
            alert('ë¨¼ì € WebSocketì— ì—°ê²°í•´ì£¼ì„¸ìš”');
            return;
        }

        const message = {
            content: content
        };

        log(`ğŸ“¤ ë©”ì‹œì§€ ì „ì†¡: ${content}`);
        stompClient.send(`/app/studies/${currentStudyId}/chats`, {}, JSON.stringify(message));
        messageInput.value = '';
    }

    function handleChatUpdate(update) {
        if (update.type === 'imoji') {
            updateReactionCount(update.messageId, update.likeCount, update.dislikeCount);
            log(`ğŸ‘ğŸ‘ ë¦¬ì•¡ì…˜ ì—…ë°ì´íŠ¸: messageId=${update.messageId}`, true);
        } else if (update.type === 'deleted') {
            deleteMessageFromUI(update.messageId);
            log(`ğŸ—‘ï¸ ë©”ì‹œì§€ ì‚­ì œ: messageId=${update.messageId}`, true);
        }
    }

    function updateReactionCount(messageId, likeCount, dislikeCount) {
        const messageDiv = messageMap.get(messageId);
        if (messageDiv) {
            const likeBtn = messageDiv.querySelector('.like-btn');
            const dislikeBtn = messageDiv.querySelector('.dislike-btn');
            
            if (likeBtn) {
                likeBtn.innerHTML = `ğŸ‘ <span class="reaction-count">${likeCount || 0}</span>`;
            }
            if (dislikeBtn) {
                dislikeBtn.innerHTML = `ğŸ‘ <span class="reaction-count">${dislikeCount || 0}</span>`;
            }
        }
    }

    function deleteMessageFromUI(messageId) {
        const messageDiv = messageMap.get(messageId);
        if (messageDiv) {
            messageDiv.classList.add('deleted');
            const contentDiv = messageDiv.querySelector('.message-content');
            contentDiv.textContent = 'ì‚­ì œëœ ë©”ì‹œì§€ì…ë‹ˆë‹¤';
            
            const actionsDiv = messageDiv.querySelector('.message-actions');
            if (actionsDiv) {
                actionsDiv.remove();
            }
        }
    }

    async function handleReaction(messageId, reactionType) {
        const authToken = document.getElementById('authToken').value;
        const currentReaction = userReactions.get(messageId);

        try {
            if (currentReaction === reactionType) {
                const response = await fetch(`/api/studies/${currentStudyId}/chats/${messageId}/reactions`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                if (response.ok) {
                    userReactions.delete(messageId);
                    updateReactionButtonState(messageId, null);
                    log(`ğŸ”„ ë¦¬ì•¡ì…˜ ì‚­ì œ ì„±ê³µ`);
                }
            } else if (currentReaction) {
                const response = await fetch(`/api/studies/${currentStudyId}/chats/${messageId}/reactions`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ reaction: reactionType })
                });
                
                if (response.ok) {
                    userReactions.set(messageId, reactionType);
                    updateReactionButtonState(messageId, reactionType);
                    log(`ğŸ”„ ë¦¬ì•¡ì…˜ ë³€ê²½ ì„±ê³µ`);
                }
            } else {
                const response = await fetch(`/api/studies/${currentStudyId}/chats/${messageId}/reactions`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ reaction: reactionType })
                });
                
                if (response.status === 201) {
                    userReactions.set(messageId, reactionType);
                    updateReactionButtonState(messageId, reactionType);
                    log(`âœ… ë¦¬ì•¡ì…˜ ìƒì„± ì„±ê³µ`);
                }
            }
        } catch (error) {
            log(`âŒ ë¦¬ì•¡ì…˜ ì²˜ë¦¬ ì—ëŸ¬: ${error.message}`, true);
        }
    }

    function updateReactionButtonState(messageId, activeReaction) {
        const messageDiv = messageMap.get(messageId);
        if (messageDiv) {
            const likeBtn = messageDiv.querySelector('.like-btn');
            const dislikeBtn = messageDiv.querySelector('.dislike-btn');
            
            if (likeBtn) {
                likeBtn.classList.toggle('active', activeReaction === 'like');
            }
            if (dislikeBtn) {
                dislikeBtn.classList.toggle('active', activeReaction === 'dislike');
            }
        }
    }

    async function handleDelete(messageId) {
        if (!confirm('ì´ ë©”ì‹œì§€ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
            return;
        }

        const authToken = document.getElementById('authToken').value;

        try {
            const response = await fetch(`/api/studies/${currentStudyId}/chats/${messageId}`, {
                method: 'DELETE',
                headers: {
                    'Authorization': `Bearer ${authToken}`
                }
            });
            
            if (response.status === 204) {
                log(`âœ… ë©”ì‹œì§€ ì‚­ì œ ì„±ê³µ`);
            }
        } catch (error) {
            log(`âŒ ë©”ì‹œì§€ ì‚­ì œ ì—ëŸ¬: ${error.message}`, true);
        }
    }

    function displayMessage(message) {
        const chatMessages = document.getElementById('chatMessages');
        const messageDiv = document.createElement('div');
        messageDiv.className = 'message';
        messageDiv.dataset.messageId = message.messageId;

        // ë‚´ê°€ ë³´ë‚¸ ë©”ì‹œì§€ë¥¼ ë°›ì•˜ì„ ë•Œ currentUserId ìë™ ì„¤ì •
        // (senderNameì´ í˜„ì¬ ë¡œê·¸ì¸í•œ ì‚¬ìš©ìì™€ ê°™ìœ¼ë©´ senderId ì €ì¥)
        if (!currentUserId && message.senderName) {
            // ë‚˜ì¤‘ì— ë‚´ê°€ ë©”ì‹œì§€ë¥¼ ë³´ë‚´ë©´ ê·¸ë•Œ ì„¤ì •ë¨
        }

        const timestamp = new Date(message.createdAt).toLocaleString();
        
        const unreadBadge = message.unreadMemberCount > 0 
            ? `<span class="unread-badge">${message.unreadMemberCount}ëª… ì•ˆ ì½ìŒ</span>`
            : '';

        // senderIdê°€ ìˆìœ¼ë©´ ë¹„êµ, ì—†ìœ¼ë©´ ëª¨ë“  ë©”ì‹œì§€ì— ì‚­ì œ ë²„íŠ¼ í‘œì‹œ (í…ŒìŠ¤íŠ¸ìš©)
        const deleteBtn = (!currentUserId || message.senderId === currentUserId)
            ? `<button class="delete-btn" onclick="handleDelete(${message.messageId})">ğŸ—‘ï¸ ì‚­ì œ</button>`
            : '';

        messageDiv.innerHTML = `
            <div class="message-header">
                <div>
                    <strong>${message.senderName}</strong> - ${timestamp}
                </div>
                ${unreadBadge}
            </div>
            <div class="message-content">${escapeHtml(message.content)}</div>
            <div class="message-actions">
                <button class="reaction-btn like-btn" onclick="handleReaction(${message.messageId}, 'like')">
                    ğŸ‘ <span class="reaction-count">0</span>
                </button>
                <button class="reaction-btn dislike-btn" onclick="handleReaction(${message.messageId}, 'dislike')">
                    ğŸ‘ <span class="reaction-count">0</span>
                </button>
                ${deleteBtn}
            </div>
        `;

        chatMessages.appendChild(messageDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
        
        messageMap.set(message.messageId, messageDiv);
    }

    function updateUnreadCountForMessagesAfter(previousLastReadMessageId) {
        messageMap.forEach((messageDiv, messageId) => {
            if (messageId > previousLastReadMessageId) {
                const badge = messageDiv.querySelector('.unread-badge');
                if (badge) {
                    const currentCount = parseInt(badge.textContent);
                    const newCount = Math.max(0, currentCount - 1);
                    
                    if (newCount === 0) {
                        badge.remove();
                    } else {
                        badge.textContent = `${newCount}ëª… ì•ˆ ì½ìŒ`;
                    }
                }
            }
        });
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    async function loadChatHistory() {
        const authToken = document.getElementById('authToken').value;
        const studyId = document.getElementById('studyId').value;

        if (!authToken || !studyId) {
            alert('ìŠ¤í„°ë”” IDì™€ JWT í† í°ì„ ì…ë ¥í•´ì£¼ì„¸ìš”');
            return;
        }

        try {
            log('ğŸ“‹ ì±„íŒ… ê¸°ë¡ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...');

            const response = await fetch(`/api/studies/${studyId}/chats?size=50`, {
                headers: {
                    'Authorization': `Bearer ${authToken}`,
                    'Content-Type': 'application/json'
                }
            });

            if (response.ok) {
                const data = await response.json();
                log(`âœ… ì±„íŒ… ê¸°ë¡ ${data.messages.length}ê°œ ë¶ˆëŸ¬ì˜´`);

                document.getElementById('chatMessages').innerHTML = '';
                messageMap.clear();
                userReactions.clear();

                data.messages.reverse().forEach(message => {
                    displayMessage(message);
                });

            } else {
                log(`âŒ ì±„íŒ… ê¸°ë¡ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: ${response.status}`, true);
            }
        } catch (error) {
            log('âŒ ì±„íŒ… ê¸°ë¡ ë¶ˆëŸ¬ì˜¤ê¸° ì—ëŸ¬: ' + error, true);
        }
    }

    document.getElementById('messageInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            sendMessage();
        }
    });

    window.onload = function() {
        log('ğŸŒŠ Pado ì±„íŒ… í…ŒìŠ¤íŠ¸ í˜ì´ì§€ ë¡œë“œë¨ (ë¦¬ì•¡ì…˜ + ì‚­ì œ)');
        log('ğŸ“ ì‚¬ìš© ì „ì— JWT í† í°ê³¼ ìŠ¤í„°ë”” IDë¥¼ ì…ë ¥í•˜ì„¸ìš”');
        log('âœ¨ ìƒˆë¡œìš´ ê¸°ëŠ¥: ì¢‹ì•„ìš”/ì‹«ì–´ìš” & ë©”ì‹œì§€ ì‚­ì œ!');
    };

    window.addEventListener('beforeunload', function() {
        if (isModalOpen) {
            closeModal();
        }
        if (stompClient !== null) {
            stompClient.disconnect();
        }
        stopHeartbeat();
    });
</script>
</body>
</html>
